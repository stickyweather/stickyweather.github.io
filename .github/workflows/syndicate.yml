name: Syndicate Social Posts

on:
  push:
    branches:
      - master  # Match your branch name
    paths:
      - '_posts/social/**'  # Only trigger on social posts

jobs:
  syndicate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get new social posts
        id: new_posts
        run: |
          # Get files added in the last commit in social directory only
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep '^_posts/social/.*\.md$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        if: steps.new_posts.outputs.files != ''
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Syndicate posts
        if: steps.new_posts.outputs.files != ''
        env:
          MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          MASTODON_INSTANCE: ${{ secrets.MASTODON_INSTANCE }}
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          cat << 'SCRIPT_EOF' > syndicate.js
          $(cat .github/scripts/syndicate.js)
          SCRIPT_EOF
          
          export NEW_FILES="${{ steps.new_posts.outputs.files }}"
          node syndicate.js "$NEW_FILES"